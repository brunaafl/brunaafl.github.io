---
layout: post
title: "Kernel Tutorials"
date: 2024-04-06
description: Talking about my experience, what I learned, and problems =]
tags:
 - mac0470
 - kernel
---

I've never had experience with virtual machines before, and at first glance, it seemed a bit dense and scary, but overall I think I had a nice learning curve over this process, it was not the smoothest one. Although the tutorials explain very nicely the goal, the commands and the meaning behind it, they do not go deeper into possible problems that may happen.

## [Use QEMU and libvirt to setup a Linux kernel test environment](https://flusp.ime.usp.br/kernel/qemu-libvirt-setup/)
 
I imagine it is better not to break your system while experimenting with kernel!

With that in mind, the purpose of this tutorial was to explain how to set up a virtual machine, i.e., an emulation of a computer inside your own machine, using **QEMU** and **libvirt** virtualization tools. 

The biggest problem I had in this tutorial was around libvirt demanding root permissions for running some commands. Trying to create the virtual machine using `create_vm_virsh_iio_workshop.sh` script got me errors related to libvirt-qemu user not having the right permissions, even when running with sudo. To deal with this, I moved `Ã¬io_workshop` directory to home. Even though it was suggested to create a group and add libvirt-qemu to it, I thought moving it would be easier and faster for me to continue.

The other issue I had was ssh system failing in my VM after copying my machine's public key on it. However, running `dpkg-reconfigure openssh-server` again, as suggested, solved quickly my problem.

## [Build the Linux kernel for ARM](https://flusp.ime.usp.br/kernel/build-linux-for-arm/)


Since, in this discipline, we want to do some test modifications on kernel, the focus of this step was to install and compile the kernel image of the IIO subsystem in our VM.

This was by far the tutorial I had the most trouble with, mostly because of some weird particularities of my machine. Firstly, my machine was, apparently, creating a default `.config` file that was incompatible with the Virtual Machine or with something related with libvirt, since, when running 

{% highlight Shell %}
{% raw %}
make -j$(nproc) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- Image.gz modules
{% endraw %}
{% endhighlight Shell %}

my configurations were being restarted. This was making it impossible to create and log in to the VM using the `create_vm_virsh_iio_workshop.sh` script, although I was still being able to boot it just with QEMU. I still haven't discovered what caused this problem, but the only solution that worked was to install the kernel using a configuration file generated by another computer.

The other problem I had was with installing the kernel and the modules, and it lies on `make -j$(nproc) Image.gz modules` command. Even if I had already defined before, in the same terminal, the **ARCH** and **CROSS_COMPILE** variables, running the make command was generating a `make:***No rule to make target 'Image.gz'. Stop` error, stopping the compilation. The installation was only successful when explicitly exporting the variables on the same command line.

I noticed this problem when compiling the kernel since it was stopping. However, it took me longer to understand that the same thing was happening while installing the modules, since no warning or error message was being printed and I could launch the machine easily. I just knew something was off in the third tutorial when, inside the VM, `lsmod` command was printing an empty list.

After analyzing step by step everything I had done until this exact point, I understood that the problem was with the variables, and running

{% highlight Shell %}
{% raw %}
make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- INSTALL_MOD_PATH=$VM_DIR/mountpoint_arm64/ modules_install
{% endraw %}
{% endhighlight Shell %}

solved my problem. One thing I can say, at least, is that taking this second, super careful look at the tutorials made me understand and connect the steps better.


## [Introduction to kernel build configuration and module](https://flusp.ime.usp.br/kernel/build-linux-for-arm/)

Now with the downloaded kernel compiled, this tutorial showed how to do a minor modification (adding a new module) on the kernel and how to configure it. Besides discovering a problem with module installation within tutorial 2, the only other issue I had in this tutorial was also related to exported variables not being recognized. When running `make menuconfig` without defining **ARCH** and **CROSS_COMPILE** in the same command, the configuration opened was related to Linux/x86 instead of arm architecture.

